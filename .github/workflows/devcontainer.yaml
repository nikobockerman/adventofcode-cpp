name: Devcontainer
on:
  pull_request:
    paths:
      - "**.cpp"
      - "**.hpp"
      - "**/CMakeLists.txt"
      - ".devcontainer/**"
      - ".github/conan-profiles/**"
      - ".github/workflows/devcontainer.yaml"
      - "aoc/**/input-*.txt"
      - "CMakePresets.json"
      - "conan.lock"
      - "conanfile.txt"
  workflow_call:
  workflow_dispatch:
permissions:
  contents: read

env:
  IMAGE_NAME: ${{ github.repository }}-devcontainer
  REGISTRY: ghcr.io

jobs:
  debug:
    name: Debug condition
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "${{ github.event_name }}"
          echo "${{ toJSON(fromJSON('["push", "workflow_dispatch"]')) }}"
          echo "${{ contains(fromJSON('["push", "workflow_dispatch"]'), github.event_name) }}"
  prebuild:
    if: contains(fromJSON('["push", "workflow_dispatch"]'), github.event_name)
    name: Prebuild devcontainer
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
        with:
          install: true
      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Prebuild devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3.1900000417
        with:
          imageName: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
          push: always

  check:
    name: Check devcontainer works
    needs:
      - prebuild
    if:
      always() && contains(fromJSON('["success", "skipped"]'),
      needs.prebuild.result)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Check devcontainer
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3.1900000417
        with:
          runCmd: |
            cmake --workflow --preset dev-clang-release && \
              ./build/clang/Release/aoc/aoc/aoc
          push: never
